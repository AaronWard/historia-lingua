<!DOCTYPE html>
<html>
<head>
    <title>Historical Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #map-container {
            height: 100%;
            width: 70%;
            float: left;
            position: relative;
        }

        #mapid {
            height: 100%;
        }

        #output-container {
            height: 90%;
            width: 30%;
            overflow-y: scroll;
            float: right;
            background-color: #f2f2f2;
            padding: 10px;
            box-sizing: border-box;
        }

        #slider-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
        }

        #year-slider {
            width: 500px;
            height: 40px;
            -webkit-appearance: none;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        #year-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 40px;
            background: #4CAF50;
            cursor: pointer;
        }

        #year-slider::-moz-range-thumb {
            width: 20px;
            height: 40px;
            background: #4CAF50;
            cursor: pointer;
        }

        #year-label {
            margin-top: 10px;
            text-align: center;
        }

        #year-label span {
            font-weight: bold;
        }

        #year-slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        #year-slider-min,
        #year-slider-max {
            font-size: 12px;
        }

        #output {
            margin-top: 20px;
            min-height: 400px;
            overflow-y: auto; 
        }

        #output p {
            margin: 0;
            overflow-y: auto; 
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .loading::before {
            content: "";
            width: 60px;
            height: 60px;
            margin-top: 50%;
            border: 6px solid #ccc;
            border-top-color: #333;
            border-radius: 70%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="mapid"></div>
    </div>
    <div id="output-container">
        <h2>Historical Facts</h2>
        <div id="output"></div>
    </div>
    <div id="slider-container">
        <div id="year-slider-labels">
            <span id="year-slider-min"></span>
            <span id="year-slider-max"></span>
        </div>
        <input id="year-slider" type="range" min="-4000" max="2000" value="-1" class="slider" step="10">
        <div id="year-label">Year: <span>0 AD</span></div>
    </div>
    <script src="https://unpkg.com/jquery"></script>
    <script src="https://unpkg.com/leaflet"></script>
    <script>
        var map = L.map('mapid').setView([51.505, -0.09], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
            attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        var output = document.getElementById('output');
        var lastMarker;
            

        map.on('click', function(e) {
            if (lastMarker) {
                map.removeLayer(lastMarker);
            }

            // TODO: fix the highlight and get location
            var location = "";

            $.ajax({
                url: '/get_location',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    lat: e.latlng.lat,
                    lon: e.latlng.lng,
                    zoom: map.getZoom(),
                    year: $('#year-slider').val()
                }),
                beforeSend: function() {
                    output.innerHTML = '<div class="loading"></div>';
                },
                success: function(response) {
                    var year = $('#year-slider').val();
                    var yearString = year <= 0 ? Math.abs(year) + ' BC' : year + ' AD';
                    location = response.address;

                    lastMarker = L.marker(e.latlng).addTo(map)
                        .bindPopup('Year: ' + yearString + '<br>' + 'Location: ' + response.address)
                        .openPopup();

                    $.ajax({
                        url: '/get_history',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            location: location,
                            year: yearString
                        }),
                        success: function(response) {
                            var facts = response.response.split(/\d+\.\s/);
                            var factsList = '<ul>';
                            for (var i = 1; i < facts.length; i++) {
                                var fact = facts[i].trim();
                                if (fact === ".") {
                                    continue; // Skip if fact is a single full stop
                                }
                                var listItem = '<li>' + fact + '</li>';
                                factsList += listItem;
                            }
                            factsList += '</ul>';

                            output.innerHTML = factsList;

                        }
                    });
                }
            });
        });

        $('#year-slider').on('input', function() {
            var year = $(this).val();
            var yearString = year <= 0 ? Math.abs(year) + ' BC' : year + ' AD';
            $('#year-label span').text(yearString);
        });

        $('#year-slider-min').text($('#year-slider').attr('min') + ' BC');
        $('#year-slider-max').text($('#year-slider').attr('max') + ' AD');

      // Event listener to detect when the user has highlighted text
        document.addEventListener('mouseup', function() {
            var year = $('#year-slider').val();
            var yearString = year <= 0 ? Math.abs(year) + ' BC' : year + ' AD';
            var previous_response = output.innerHTML
            var selectedText = window.getSelection().toString().trim();
            // var current_text = 
            if (selectedText.length > 0) {
                $.ajax({
                    url: '/handle_selected_text',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        location: location,
                        year: yearString,
                        previous_response: previous_response,
                        selected_text: selectedText
                    }),
                    beforeSend: function() {
                        output.innerHTML = '<div class="loading"></div>';
                    },
                    success: function(response) {
                        var facts = response.response.split(/\d+\.\s/);
                        var factsList = '<ul>';
                        for (var i = 1; i < facts.length; i++) {
                            var fact = facts[i].trim();
                            if (fact === ".") {
                                continue; // Skip if fact is a single full stop
                            }
                            var listItem = '<li>' + fact + '</li>';
                            factsList += listItem;
                        }
                        factsList += '</ul>';

                        output.innerHTML = factsList;

                    },
                    error: function(xhr, status, error) {
                        console.error(error);
                    }
                });
            }
        });

    </script>
</body>
</html>